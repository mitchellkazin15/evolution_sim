<!DOCTYPE html>
<html>
	<head>
		<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
	</head>
	<canvas id="myCanvas"></canvas>
	<body onload="startGame()">
		<script>

			const cellSize = 5;
			const canvasSize = (Math.pow(2,7) + 1) * cellSize;
			
			var groundArray = new Array(canvasSize / cellSize);
			for(var i = 0; i < groundArray.length; ++i){
				groundArray[i] = new Array(canvasSize / cellSize);
			}
			
			function startGame() {
				diamondSquare();
				//randomGrid();
				myGameArea.start();
			}
			
			var myGameArea = {
				canvas : document.getElementById("myCanvas"),
				start : function() {
					this.canvas.width = canvasSize;
					this.canvas.height = canvasSize;
					this.context = this.canvas.getContext("2d");
					document.body.insertBefore(this.canvas, document.body.childNodes[0]);
					this.frameNo = 0;
					this.interval = setInterval(updateGameArea, 200);
				},
				clear : function() {
					this.context.clearRect(0, 0, this.canvas.width, this.canvas.height);
				}
			}
			
			function groundCell(height,food,water,roughness,x,y){
				this.food = food;
				this.water = water;
				this.roughness = roughness;
				this.height = height;
				this.x = x;
				this.y = y;
				this.update = function(){
					ctx = myGameArea.context;
					ctx.fillStyle = rgbToHex(this.roughness,this.food,this.water);
					ctx.fillRect(this.x*cellSize,this.y*cellSize,cellSize,cellSize);
				}
			}
			
			function updateGameArea() {
				for(var i = 0; i < groundArray.length; ++i){
					for(var j = 0; j < groundArray[i].length;++j){
						groundArray[i][j].update();
					}
				}
			}
			
			function randomGrid(){
				for(var i = 0; i < groundArray.length; ++i){
					for(var j = 0; j < groundArray[i].length;++j){
						var food = Math.floor(Math.random() * 256);
						var water = Math.floor(Math.random() * 256);
						var roughness = Math.floor(Math.random() * 256);
						var height = Math.floor(Math.random() * 256);
						groundArray[i][j] = new groundCell(height,food,water,roughness,j,i);
					}
				}
			}
			
			function diamondSquare(){
				var x = 0;
				var y = 0;
				var size = canvasSize/cellSize;
				if (typeof groundArray[x][y] === 'undefined' || groundArray[x][y] === null) {
    				var food = Math.floor(Math.random() * 256);
					var water = Math.floor(Math.random() * 256);
					var roughness = Math.floor(Math.random() * 256);
					var height = Math.floor(Math.random() * 256);
					groundArray[x][y] = new groundCell(height,food,water,roughness,x,y);
				}
				if (typeof groundArray[x + size - 1][y] === 'undefined' || groundArray[x + size - 1][y] === null) {
    				var food = Math.floor(Math.random() * 256);
					var water = Math.floor(Math.random() * 256);
					var roughness = Math.floor(Math.random() * 256);
					var height = Math.floor(Math.random() * 256);
					groundArray[x + size - 1][y] = new groundCell(height,food,water,roughness,(x + size - 1),y);
				}
				if (typeof groundArray[x][y + size - 1] === 'undefined' || groundArray[x][y + size - 1] === null) {
    				var food = Math.floor(Math.random() * 256);
					var water = Math.floor(Math.random() * 256);
					var roughness = Math.floor(Math.random() * 256);
					var height = Math.floor(Math.random() * 256);
					groundArray[x][y + size - 1] = new groundCell(height,food,water,roughness,x,(y + size - 1));
				}
				if (typeof groundArray[x + size - 1][y + size - 1] === 'undefined' || groundArray[x + size - 1][y + size - 1] === null) {
    				var food = Math.floor(Math.random() * 256);
					var water = Math.floor(Math.random() * 256);
					var roughness = Math.floor(Math.random() * 256);
					var height = Math.floor(Math.random() * 256);
					groundArray[x + size - 1][y + size - 1] = new groundCell(height,food,water,roughness,(x + size - 1),(y + size - 1));
				}
				diamondSquareRec(canvasSize/cellSize,0,0);
			}
			
			function diamondSquareRec(size,x,y){
				if(size == 2){
					return;
				}
				var midList = new Array(4);
				midList[0] = groundArray[x][y];
				midList[1] = groundArray[x + size - 1][y];
				midList[2] = groundArray[x][y + size - 1];
				midList[3] = groundArray[x + size - 1][y + size - 1];
				var midSize = Math.ceil(size / 2);
				
				var midX = x + midSize - 1;
				var midY = y + midSize - 1;
				groundArray[midX][midY] = avgCell(midList,midX,midY,size);
				
				var topList = [groundArray[midX][midY],midList[0],midList[1]];
				var topX = x + midSize - 1;
				var topY = y;
				groundArray[topX][topY] = avgCell(topList,topX,topY,15);
				
				var rightList = [groundArray[midX][midY],midList[1],midList[3]];
				var rX = x + size - 1;
				var rY = y + midSize - 1;
				groundArray[rX][rY] = avgCell(rightList,rX,rY,size);
				
				var botList = [groundArray[midX][midY],midList[3],midList[2]];
				var botX = x + midSize - 1;
				var botY = y + size -1;
				groundArray[botX][botY] = avgCell(botList,botX,botY,size);
				
				var leftList = [groundArray[midX][midY],midList[0],midList[2]];
				var lX = x;
				var lY = y + midSize - 1;
				groundArray[lX][lY] = avgCell(leftList,lX,lY,size);
				
				diamondSquareRec(midSize,x,y);
				diamondSquareRec(midSize,topX,y);
				diamondSquareRec(midSize,midX,midY);
				diamondSquareRec(midSize,x,lY);
			}
			
			function avgCell(cellList,x,y,randRange){
				var avgheight = 0;
				var avgfood = 0;
				var avgwater = 0;
				var avgrough = 0;
				for(var i = 0; i < cellList.length; i++){
					avgheight += cellList[i].height;
					avgfood += cellList[i].food;
					avgwater += cellList[i].water;
					avgrough += cellList[i].roughness;
				}
				avgheight = Math.floor((avgheight / cellList.length) + Math.floor(Math.random() * randRange));
				avgfood = Math.floor((avgfood / cellList.length) + Math.floor(Math.random() * randRange));
				avgwater = Math.floor((avgwater / cellList.length) + Math.floor(Math.random() * randRange));
				avgrough = Math.floor((avgrough / cellList.length) + Math.floor(Math.random() * randRange));
				var avgCell = new groundCell(avgheight,avgfood,avgwater,avgrough, x, y);
				return avgCell;
			}
			
			function componentToHex(c) {
    			var hex = c.toString(16);
    			return hex.length == 1 ? "0" + hex : hex;
			}
			
			function rgbToHex(r, g, b) {
    			return "#" + componentToHex(r) + componentToHex(g) + componentToHex(b);
			}
		</script>
	</body>
</html>
